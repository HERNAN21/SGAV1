import{Y as k,_ as ve,T as ge,r as d,U as ye,o as c,h as v,w as r,b as p,V as fe,e as x,W as _e,c as K,F as N,i as A,f as S,t as be,E as C,g,O as U,X as he,Z as we}from"./index-DlKmiQXQ.js";const E={getSchemas(){return k.get("/admin/formularios/schemas")},getCatalogs(){return k.get("/admin/formularios/catalogos")},list(_,b={}){return k.get(_,{params:b})},create(_,b){return k.post(_,b)},update(_,b,M){return k.put(`${_}/${b}`,M)},remove(_,b){return k.delete(`${_}/${b}`)}},Ve={class:"crud-header"},ke={class:"pager"},xe={__name:"DynamicCrudModule",props:{entity:{type:String,required:!0}},setup(_){const b=_,M=g(!1),Y=g(!1),w=g(!1),R=g(!1),j=g(1),q=g(15),T=g(0),G=g([]),z=g(""),I=g({}),L=g({}),F=g(null),n=we({}),m=U(()=>I.value[b.entity]||null),B=U(()=>{var t;return((t=m.value)==null?void 0:t.endpoint)||"/admin/instituciones"}),$=U(()=>{var t;return((t=m.value)==null?void 0:t.primaryKey)||"id"}),O=U(()=>{var e;const t={};for(const a of((e=m.value)==null?void 0:e.fields)||[])t[a.name]=a;return t}),Z=U(()=>{var t;return(t=m.value)!=null&&t.fields?Array.isArray(m.value.listColumns)&&m.value.listColumns.length>0?m.value.listColumns.map(e=>{if(typeof e=="string"){const l=O.value[e];return{prop:e,label:(l==null?void 0:l.label)||e}}const a=O.value[e.prop];return{prop:e.prop,label:e.label||(a==null?void 0:a.label)||e.prop}}):m.value.fields.filter(e=>!["password","textarea","switch","multiselect"].includes(e.type)).slice(0,6).map(e=>({prop:e.name,label:e.label})):[]}),H=U(()=>{var e;const t={};for(const a of((e=m.value)==null?void 0:e.fields)||[]){const l=[];a.required&&l.push({required:!0,message:`${a.label} es obligatorio`,trigger:"blur"}),a.type==="email"&&l.push({type:"email",message:"Email inválido",trigger:"blur"}),a.maxlength&&l.push({max:a.maxlength,message:`Máximo ${a.maxlength} caracteres`,trigger:"blur"}),a.minlength&&l.push({min:a.minlength,message:`Mínimo ${a.minlength} caracteres`,trigger:"blur"}),l.length>0&&(t[a.name]=l)}return t}),D=t=>L.value[t]||[],J=(t,e)=>{const a=e==null?void 0:e.property,l=t==null?void 0:t[a],s=O.value[a];if((s==null?void 0:s.type)==="select"&&s.optionsKey){const y=D(s.optionsKey).find(f=>String(f.value)===String(l));return(y==null?void 0:y.label)||l||"-"}if((s==null?void 0:s.type)==="multiselect"){if(Array.isArray(l)){const y=new Map(D(s.optionsKey).map(h=>[String(h.value),h.label])),f=l.map(h=>y.get(String(h))||h).filter(Boolean);return f.length?f.join(", "):"-"}if(b.entity==="usuarios"&&Array.isArray(t==null?void 0:t.roles_catalogo)){const y=t.roles_catalogo.map(f=>f==null?void 0:f.nombre).filter(Boolean);return y.length?y.join(", "):"-"}}return(s==null?void 0:s.type)==="switch"?l?"Sí":"No":l==null||l===""?"-":l},P=()=>{var t;Object.keys(n).forEach(e=>delete n[e]);for(const e of((t=m.value)==null?void 0:t.fields)||[])e.type==="switch"?n[e.name]=!0:e.type==="multiselect"?n[e.name]=[]:n[e.name]=""},Q=()=>{var e;const t={};for(const a of((e=m.value)==null?void 0:e.fields)||[]){const l=n[a.name];a.type==="password"&&R.value&&!l||(t[a.name]=l===""?null:l)}return t},V=async()=>{var t,e;if(m.value){M.value=!0;try{const{data:a}=await E.list(B.value,{page:j.value,search:z.value});G.value=a.data||[],T.value=a.total||0,q.value=a.per_page||15}catch(a){C.error(((e=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:e.message)||"Error al listar registros")}finally{M.value=!1}}},ee=async()=>{const[t,e]=await Promise.all([E.getSchemas(),E.getCatalogs()]);I.value=t.data,L.value=e.data},ae=()=>{R.value=!1,P(),w.value=!0},te=t=>{var e;R.value=!0,P();for(const a of((e=m.value)==null?void 0:e.fields)||[])if(a.name!=="password"){if(a.name==="roles"){n[a.name]=(t.roles_catalogo||[]).map(l=>l.id_rol);continue}n[a.name]=t[a.name]??(a.type==="multiselect"?[]:"")}n[$.value]=t[$.value],w.value=!0},le=async()=>{var t,e,a;if(F.value){await F.value.validate(),Y.value=!0;try{const l=Q();R.value?(await E.update(B.value,n[$.value],l),C.success("Registro actualizado")):(await E.create(B.value,l),C.success("Registro creado")),w.value=!1,await V()}catch(l){if(((t=l==null?void 0:l.response)==null?void 0:t.status)===422){const s=Object.values(l.response.data.errors||{})[0];if(s!=null&&s[0]){C.error(s[0]);return}}C.error(((a=(e=l==null?void 0:l.response)==null?void 0:e.data)==null?void 0:a.message)||"No se pudo guardar")}finally{Y.value=!1}}},oe=async t=>{try{await he.confirm("¿Eliminar este registro?","Confirmación",{type:"warning"}),await E.remove(B.value,t[$.value]),C.success("Registro eliminado"),await V()}catch{}},ne=async t=>{j.value=t,await V()};return ge(async()=>{await ee(),P(),await V()}),(t,e)=>{const a=d("el-button"),l=d("el-input"),s=d("el-col"),y=d("el-row"),f=d("el-table-column"),h=d("el-table"),se=d("el-pagination"),W=d("el-option"),X=d("el-select"),re=d("el-date-picker"),ue=d("el-switch"),ie=d("el-form-item"),ce=d("el-form"),pe=d("el-dialog"),me=d("el-card"),de=ye("loading");return c(),v(me,{shadow:"never",class:"crud-card"},{header:r(()=>{var i;return[S("div",Ve,[S("div",null,[S("h3",null,be(((i=m.value)==null?void 0:i.title)||_.entity),1),e[3]||(e[3]=S("small",null,"Formulario dinámico con validaciones",-1))]),p(a,{type:"primary",onClick:ae},{default:r(()=>[...e[4]||(e[4]=[x("Nuevo registro",-1)])]),_:1})])]}),default:r(()=>[p(y,{gutter:12,class:"toolbar-row"},{default:r(()=>[p(s,{xs:24,md:12},{default:r(()=>[p(l,{modelValue:z.value,"onUpdate:modelValue":e[0]||(e[0]=i=>z.value=i),placeholder:"Buscar...",clearable:"",onKeyup:fe(V,["enter"])},null,8,["modelValue"])]),_:1}),p(s,{xs:24,md:12,class:"toolbar-actions"},{default:r(()=>[p(a,{onClick:V},{default:r(()=>[...e[5]||(e[5]=[x("Buscar",-1)])]),_:1})]),_:1})]),_:1}),_e((c(),v(h,{data:G.value,border:"",stripe:"",style:{width:"100%"}},{default:r(()=>[(c(!0),K(N,null,A(Z.value,i=>(c(),v(f,{key:i.prop,prop:i.prop,label:i.label,formatter:J,"min-width":"140"},null,8,["prop","label"]))),128)),p(f,{label:"Acciones",width:"180",fixed:"right"},{default:r(({row:i})=>[p(a,{link:"",type:"primary",onClick:o=>te(i)},{default:r(()=>[...e[6]||(e[6]=[x("Editar",-1)])]),_:1},8,["onClick"]),p(a,{link:"",type:"danger",onClick:o=>oe(i)},{default:r(()=>[...e[7]||(e[7]=[x("Eliminar",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[de,M.value]]),S("div",ke,[p(se,{background:"",layout:"prev, pager, next",total:T.value,"page-size":q.value,"current-page":j.value,onCurrentChange:ne},null,8,["total","page-size","current-page"])]),p(pe,{modelValue:w.value,"onUpdate:modelValue":e[2]||(e[2]=i=>w.value=i),title:R.value?"Editar":"Nuevo",width:"760px"},{footer:r(()=>[p(a,{onClick:e[1]||(e[1]=i=>w.value=!1)},{default:r(()=>[...e[8]||(e[8]=[x("Cancelar",-1)])]),_:1}),p(a,{type:"primary",loading:Y.value,onClick:le},{default:r(()=>[...e[9]||(e[9]=[x("Guardar",-1)])]),_:1},8,["loading"])]),default:r(()=>[p(ce,{ref_key:"formRef",ref:F,model:n,rules:H.value,"label-position":"top"},{default:r(()=>[p(y,{gutter:12},{default:r(()=>{var i;return[(c(!0),K(N,null,A(((i=m.value)==null?void 0:i.fields)||[],o=>(c(),v(s,{key:o.name,xs:24,sm:o.type==="textarea"?24:12},{default:r(()=>[p(ie,{label:o.label,prop:o.name},{default:r(()=>[o.type==="select"?(c(),v(X,{key:0,modelValue:n[o.name],"onUpdate:modelValue":u=>n[o.name]=u,filterable:"",clearable:"",style:{width:"100%"}},{default:r(()=>[(c(!0),K(N,null,A(D(o.optionsKey),u=>(c(),v(W,{key:u.value,label:u.label,value:u.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):o.type==="multiselect"?(c(),v(X,{key:1,modelValue:n[o.name],"onUpdate:modelValue":u=>n[o.name]=u,multiple:"",filterable:"",clearable:"",style:{width:"100%"}},{default:r(()=>[(c(!0),K(N,null,A(D(o.optionsKey),u=>(c(),v(W,{key:u.value,label:u.label,value:u.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):o.type==="date"?(c(),v(re,{key:2,modelValue:n[o.name],"onUpdate:modelValue":u=>n[o.name]=u,type:"date","value-format":"YYYY-MM-DD",placeholder:"Selecciona fecha",style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])):o.type==="switch"?(c(),v(ue,{key:3,modelValue:n[o.name],"onUpdate:modelValue":u=>n[o.name]=u},null,8,["modelValue","onUpdate:modelValue"])):o.type==="textarea"?(c(),v(l,{key:4,modelValue:n[o.name],"onUpdate:modelValue":u=>n[o.name]=u,type:"textarea",rows:3},null,8,["modelValue","onUpdate:modelValue"])):(c(),v(l,{key:5,modelValue:n[o.name],"onUpdate:modelValue":u=>n[o.name]=u,type:o.type==="password"?"password":"text","show-password":o.type==="password",maxlength:o.maxlength||null},null,8,["modelValue","onUpdate:modelValue","type","show-password","maxlength"]))]),_:2},1032,["label","prop"])]),_:2},1032,["sm"]))),128))]}),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])]),_:1})}}},Ue=ve(xe,[["__scopeId","data-v-7cb49c3f"]]);export{Ue as D};
